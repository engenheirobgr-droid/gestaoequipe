<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadro de Gestão de Demandas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, writeBatch, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // *******************************************************************
        // ** PASSO IMPORTANTE: COLE A CONFIGURAÇÃO DO SEU FIREBASE AQUI **
        // Copie o objeto 'firebaseConfig' das configurações do seu projeto no Firebase
        // e substitua a linha de placeholder abaixo.
        // Exemplo:
        // const firebaseConfig = {
        //   apiKey: "AIzaSy...",
        //   authDomain: "seu-projeto.firebaseapp.com",
        //   ...
        // };
        const firebaseConfig = {
    apiKey: "AIzaSyB3jYiqJ2GO_N6tVmBQcxXo630B4ks0zzg",
    authDomain: "gestao-de-equipe.firebaseapp.com",
    projectId: "gestao-de-equipe",
    storageBucket: "gestao-de-equipe.firebasestorage.app",
    messagingSenderId: "545987735171",
    appId: "1:545987735171:web:ad1c63e748969a497e35b6"
  };;
        // *******************************************************************

        // Verifica se a configuração é apenas um placeholder
        const isConfigPlaceholder = !firebaseConfig || Object.keys(firebaseConfig).length === 0 || firebaseConfig.apiKey === undefined;

        if (isConfigPlaceholder) {
            // Se a configuração estiver faltando, exibe uma mensagem de erro clara e para a execução.
            document.addEventListener('DOMContentLoaded', () => {
                document.body.innerHTML = `
                    <div class="bg-gray-900 text-white p-8 text-center h-screen flex flex-col justify-center items-center">
                        <div class="bg-red-800 border border-red-600 p-10 rounded-lg shadow-2xl max-w-2xl">
                            <h1 class="text-3xl font-bold mb-4">Erro de Configuração</h1>
                            <p class="text-lg">A configuração do Firebase não foi encontrada no código do aplicativo.</p>
                            <p class="mt-4 text-gray-300 text-left">
                                <strong>Para corrigir:</strong><br>
                                1. Abra o console do seu projeto no Firebase.<br>
                                2. Vá para "Configurações do Projeto" (ícone de engrenagem).<br>
                                3. Na aba "Geral", role até "Seus apps".<br>
                                4. Em "Configuração e Instalação do SDK", selecione "CDN".<br>
                                5. Copie o objeto de código <strong>const firebaseConfig = { ... };</strong><br>
                                6. Edite o arquivo <strong>app_gestao.html</strong>, encontre este mesmo local no código e cole o objeto que você copiou.<br>
                                7. Salve e envie o arquivo atualizado para o GitHub.
                            </p>
                        </div>
                    </div>
                `;
            });
            // Lança um erro para parar completamente a execução do script.
            throw new Error("Configuração do Firebase ausente. O usuário foi notificado na tela.");
        } else {
            // Se a configuração existe, inicializa o Firebase.
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            // Enable debug logging for Firestore
            // setLogLevel('debug');

            // Make db and auth available globally for our main script
            window.db = db;
            window.auth = auth;
            window.firebase = {
                 doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, 
                 collection, query, writeBatch, getDocs, signInAnonymously, 
                 signInWithCustomToken, onAuthStateChanged
            };
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .kanban-column { min-height: 200px; }
        .kanban-card { cursor: grab; transition: background-color 0.2s, box-shadow 0.2s; }
        .kanban-card:active { cursor: grabbing; }
        .dragging { opacity: 0.5; transform: rotate(3deg); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; }
        #table-container thead th { position: sticky; top: 0; z-index: 1; background-color: #1f2937; }
        .wip-limit-exceeded { color: #ef4444; font-weight: bold; }
        .tooltip-container { position: relative; display: inline-flex; align-items: center; }
        .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        .tooltip-container:hover .tooltip { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <header class="bg-gray-800 p-4 shadow-md sticky top-0 z-20">
        <div class="container mx-auto flex justify-between items-center flex-wrap">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold">Gestão de Engenharia</h1>
                <div id="view-toggle-container" class="flex items-center text-sm pt-1">
                    <span class="mr-2 text-gray-400">Visão Equipe</span>
                    <label for="view-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="view-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                    <span class="ml-2 font-semibold">Visão Gerencial</span>
                </div>
            </div>
            <div class="flex space-x-2">
                <button id="export-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /> </svg>
                    <span>Exportar</span>
                </button>
                <button id="add-demand-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /> </svg>
                    <span>Nova Demanda</span>
                </button>
            </div>
        </div>
    </header>
    <input type="file" id="file-input" class="hidden" accept=".xlsx,.xls,.csv,.iqy">
    <div class="container mx-auto px-4 border-b border-gray-700 sticky top-[72px] bg-gray-900 z-10">
        <nav class="flex space-x-8">
            <button id="tab-dashboard" class="tab-btn active py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span>Dashboard</span>
            </button>
            <button id="tab-kanban" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" />
                </svg>
                <span>Quadro Kanban</span>
            </button>
            <button id="tab-demandas" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition flex items-center">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <span>Demandas</span>
            </button>
             <button id="tab-catalogo" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 10h16M4 13h16M4 16h16" />
                </svg>
                <span>Catálogo</span>
            </button>
            <button id="tab-hc" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656-.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span>Head Count (HC)</span>
            </button>
        </nav>
    </div>
    <div id="global-filters-panel" class="container mx-auto px-4 pt-4">
        <div class="bg-gray-800 rounded-lg p-4">
            <h2 class="text-xl font-bold mb-4">Filtros</h2>
            <div id="global-filters" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm">
            </div>
            <button id="clear-filters-btn" class="mt-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center space-x-2 justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
                <span>Limpar Filtros</span>
            </button>
        </div>
    </div>
    <div id="tab-content" class="container mx-auto p-4">
        <div id="view-dashboard">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-gray-800 p-4 rounded-lg text-center">
                    <h3 class="text-lg font-semibold text-gray-400">Cycle Time Médio</h3>
                    <p id="kpi-cycle-time" class="text-3xl font-bold text-blue-400">-- dias</p>
                    <p class="text-xs text-gray-500">(Do início ao fim da execução)</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg text-center">
                    <h3 class="text-lg font-semibold text-gray-400">Lead Time Médio</h3>
                    <p id="kpi-lead-time" class="text-3xl font-bold text-purple-400">-- dias</p>
                    <p class="text-xs text-gray-500">(Da criação à entrega final)</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg text-center">
                    <h3 class="text-lg font-semibold text-gray-400">Vazão (Últimos 7 dias)</h3>
                    <p id="kpi-throughput" class="text-3xl font-bold text-green-400">-- itens</p>
                    <p class="text-xs text-gray-500">(Itens concluídos)</p>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold text-center mb-2">Em Execução Agora</h3>
                <div id="wip-tracker-container" class="space-y-1">
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-800 p-4 rounded-lg col-span-1 lg:col-span-2 h-[450px]"><canvas id="cumulativeFlowChart"></canvas></div>
                <div class="bg-gray-800 p-4 rounded-lg col-span-1 lg:col-span-2 h-[450px]"><canvas id="timeEvolutionChart"></canvas></div>
                <div class="bg-gray-800 p-4 rounded-lg h-[450px]"><canvas id="responsaveisChart"></canvas></div>
                <div class="bg-gray-800 p-4 rounded-lg h-[450px]"><canvas id="statusDistributionChart"></canvas></div>
                <div id="effort-analysis-chart-container" class="bg-gray-800 p-4 rounded-lg col-span-1 lg:col-span-2 h-[450px]"><canvas id="effortAnalysisChart"></canvas></div>
                <div id="efficiency-chart-container" class="bg-gray-800 p-4 rounded-lg col-span-1 lg:col-span-2 h-[450px]"><canvas id="efficiencyChart"></canvas></div>
                <div class="col-span-1 lg:col-span-2 bg-gray-800 p-4 rounded-lg">
                    <div class="flex justify-end mb-4">
                         <select id="time-log-week-selector" class="bg-gray-700 border border-gray-600 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div class="grid grid-cols-1 gap-6">
                         <div class="h-[450px]"><canvas id="collaboratorHoursChart"></canvas></div>
                         <div class="h-[450px]"><canvas id="processHoursChart"></canvas></div>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg col-span-1 lg:col-span-2 h-[450px]"><canvas id="nucleoChart"></canvas></div>
            </div>
        </div>
        <div id="view-demandas" class="hidden">
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h2 class="text-xl font-bold">Demandas Importadas</h2>
                    <div class="flex space-x-2">
                        <button id="import-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /> </svg>
                            <span>Importar Demandas</span>
                        </button>
                        <button id="clear-data-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /> </svg>
                            <span>Limpar Demandas</span>
                        </button>
                    </div>
                </div>
                <div id="duplicate-warning" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg relative mb-4" role="alert">
                    <strong class="font-bold">Atenção:</strong>
                    <span class="block sm:inline" id="duplicate-message"></span>
                </div>
                <div id="table-container" class="overflow-auto text-sm max-h-[60vh] rounded-lg">
                    <p class="text-gray-400 p-4">Nenhum dado importado. Clique em "Importar Demandas" para começar.</p>
                </div>
            </div>
        </div>
        <div id="view-catalogo" class="hidden">
        </div>
        <div id="view-hc" class="hidden">
        </div>
        <div id="view-kanban" class="hidden">
        </div>
    </div>
    
    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const { db, auth, firebase } = window;
            if (!db || !auth || !firebase) {
                console.error("A inicialização do Firebase falhou. O aplicativo não pode continuar.");
                return;
            }
            const appId = 'gestaoequipe';
            let tasksCollectionRef;
            let configDocRef;
            let unsubscribeTasks = () => {};
            let unsubscribeConfig = () => {};
            const WIP_LIMIT = 5;
            let tasks = [];
            let allHeaders = [];
            let history = [];
            let timeLog = [];
            let activityCatalog = {};
            let duplicateIdList = [];
            let teamMembers = [];
            let draggedTaskId = null;
            let chartObjects = {};
            let currentSort = { by: 'score', direction: 'desc' };
            let timerInterval = null;
            let currentView = 'manager';
            let isManager = false;
            let userId = null;
            let dataLoaded = false;
            const defaultActivityCatalog = {
                "Elaboração de OGs para novas obras em TAF (OLTC. BC e Reator)": { "time": 1.3, "process": "Tensão em regime permanente", "annualNeed": 200, "executionPercentage": 100, "role": "Eng" },
                "Elaboração de OGs para RTs/BCs (plano 8.4) Revisão de OGS": { "time": 0.8, "process": "Tensão em regime permanente", "annualNeed": 402, "executionPercentage": 100, "role": "Eng/Tec" },
            };
            const elements = {
                addDemandBtn: document.getElementById('add-demand-btn'),
                importBtn: document.getElementById('import-btn'),
                exportBtn: document.getElementById('export-btn'),
                fileInput: document.getElementById('file-input'),
                clearFiltersBtn: document.getElementById('clear-filters-btn'),
                clearDataBtn: document.getElementById('clear-data-btn'),
                viewToggle: document.getElementById('view-toggle'),
                viewToggleContainer: document.getElementById('view-toggle-container'),
                tabs: { dashboard: document.getElementById('tab-dashboard'), demandas: document.getElementById('tab-demandas'), kanban: document.getElementById('tab-kanban'), catalogo: document.getElementById('tab-catalogo'), hc: document.getElementById('tab-hc') },
                views: { dashboard: document.getElementById('view-dashboard'), demandas: document.getElementById('view-demandas'), kanban: document.getElementById('view-kanban'), catalogo: document.getElementById('view-catalogo'), hc: document.getElementById('view-hc') },
                tableContainer: document.getElementById('table-container'),
                duplicateWarning: document.getElementById('duplicate-warning'),
                duplicateMessage: document.getElementById('duplicate-message'),
                kanbanBoard: document.getElementById('kanban-board'),
                kanbanColumns: document.querySelectorAll('.kanban-column'),
                globalFilters: document.getElementById('global-filters'),
                kanbanSortBy: document.getElementById('kanban-sort-by'),
                kanbanSortDirection: document.getElementById('kanban-sort-direction'),
                timeLogWeekSelector: document.getElementById('time-log-week-selector'),
                catalog: {
                    container: document.getElementById('catalog-table-container'),
                    addBtn: document.getElementById('add-activity-btn'),
                    modal: document.getElementById('catalog-edit-modal'),
                    form: document.getElementById('catalog-edit-form'),
                    title: document.getElementById('catalog-modal-title'),
                    originalName: document.getElementById('original-activity-name'),
                    editName: document.getElementById('edit-activity-name'),
                    editProcess: document.getElementById('edit-activity-process'),
                    editRole: document.getElementById('edit-activity-role'),
                    editTime: document.getElementById('edit-activity-time'),
                    editAnnualNeed: document.getElementById('edit-activity-annual-need'),
                    editExecPercentage: document.getElementById('edit-activity-execution-percentage'),
                    deleteBtn: document.getElementById('delete-activity-btn'),
                    cancelBtn: document.getElementById('cancel-catalog-edit-btn')
                },
                hc: {
                    hoursInput: document.getElementById('hc-hours-input'),
                    productivityFactor: document.getElementById('hc-productivity-factor'),
                    baseTotal: document.getElementById('hc-base-total'),
                    currentTotal: document.getElementById('hc-current-total'),
                    annualTotal: document.getElementById('hc-annual-total'),
                    realTotal: document.getElementById('hc-real-total'),
                    baseEng: document.getElementById('hc-base-eng'),
                    currentEng: document.getElementById('hc-current-eng'),
                    annualEng: document.getElementById('hc-annual-eng'),
                    realEng: document.getElementById('hc-real-eng'),
                    baseTec: document.getElementById('hc-base-tec'),
                    currentTec: document.getElementById('hc-current-tec'),
                    annualTec: document.getElementById('hc-annual-tec'),
                    realTec: document.getElementById('hc-real-tec'),
                },
                effortAnalysisChartContainer: document.getElementById('effort-analysis-chart-container'),
                efficiencyChartContainer: document.getElementById('efficiency-chart-container'),
                kpis: {
                    cycleTime: document.getElementById('kpi-cycle-time'),
                    leadTime: document.getElementById('kpi-lead-time'),
                    throughput: document.getElementById('kpi-throughput')
                },
                modal: {
                    container: document.getElementById('demand-modal'),
                    form: document.getElementById('demand-form'),
                    title: document.getElementById('modal-title'),
                    id: document.getElementById('demand-id'),
                    status: document.getElementById('demand-status'),
                    demandTitle: document.getElementById('demand-title'),
                    responsible: document.getElementById('demand-responsible'),
                    nucleus: document.getElementById('demand-nucleus'),
                    description: document.getElementById('demand-description'),
                    type: document.getElementById('demand-type'),
                    completionDateWrapper: document.getElementById('completion-date-wrapper'),
                    completionDate: document.getElementById('demand-completion-date'),
                    originalDataContent: document.getElementById('original-data-content'),
                    critScore: document.getElementById('crit-score'),
                    critReclamacoes: document.getElementById('crit-reclamacoes'),
                    critPrazo: document.getElementById('crit-prazo'),
                    gut: {
                        fields: document.getElementById('gut-fields'),
                        g: document.getElementById('gut-g'), u: document.getElementById('gut-u'), t: document.getElementById('gut-t'),
                        formula: document.getElementById('gut-formula-display'),
                        score: document.getElementById('gut-score-display')
                    },
                    rice: {
                        fields: document.getElementById('rice-fields'),
                        reach: document.getElementById('rice-reach'), impact: document.getElementById('rice-impact'),
                        confidence: document.getElementById('rice-confidence'), effort: document.getElementById('rice-effort'),
                        formula: document.getElementById('rice-formula-display'),
                        score: document.getElementById('rice-score-display')
                    },
                    closeBtn: document.getElementById('close-modal-btn'),
                    cancelBtn: document.getElementById('cancel-btn'),
                    deleteBtn: document.getElementById('delete-demand-btn')
                }
            };
            const initFirebase = async () => {
                firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuário autenticado:", userId);

                        tasksCollectionRef = firebase.collection(db, `artifacts/${appId}/public/data/tasks`);
                        configDocRef = firebase.doc(db, `artifacts/${appId}/public/data/appConfig/main`);

                        const configSnap = await firebase.getDoc(configDocRef);
                        if (configSnap.exists() && configSnap.data().managers?.includes(userId)) {
                            isManager = true;
                        } else {
                            if (!configSnap.exists()) {
                                 await firebase.setDoc(configDocRef, { managers: [userId] });
                                 isManager = true;
                            } else {
                                isManager = false;
                            }
                        }

                        elements.viewToggleContainer.style.display = isManager ? 'flex' : 'none';
                        loadDataAndInitApp();

                    } else {
                        console.log("Nenhum usuário logado.");
                        unsubscribeTasks();
                        unsubscribeConfig();
                    }
                });

                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         await firebase.signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                         await firebase.signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autenticação:", error);
                    alert("Não foi possível conectar ao sistema. Verifique sua conexão e tente novamente.");
                }
            };
            initFirebase();
        });
    </script>
</body>
</html>

